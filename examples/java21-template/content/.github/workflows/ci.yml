name: CI/CD

on:
  workflow_dispatch:
    inputs:
      publish:
        description: "Publish Docker image?"
        required: true
        default: "false"

jobs:
# ------------------------
# BUILD & TEST
# ------------------------
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - run: mvn clean verify

# ------------------------
# DOCKER PUBLISH (MANUAL ONLY)
# ------------------------
  docker:
    runs-on: ubuntu-latest
    needs: build
    if: inputs.publish == 'true'

    steps:
      - uses: actions/checkout@v4

      # ✅ Debug (safe, does not leak secrets)
      - name: Debug Docker secrets
        run: |
          echo "USERNAME present -> ${{ secrets.DOCKERHUB_USERNAME != '' }}"
          echo "TOKEN present -> ${{ secrets.DOCKERHUB_TOKEN != '' }}"

      # ✅ Fail fast if secrets missing
      - name: Validate Docker secrets
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          if [ -z "$DOCKERHUB_USERNAME" ] || [ -z "$DOCKERHUB_TOKEN" ]; then
            echo "❌ Docker secrets not available"
            exit 1
          fi

      # ✅ Docker login (unchanged)
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ✅ Correct image name
      - name: Build Docker image
        run: |
          IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}
          docker build -t $IMAGE:latest .

      - name: Push Docker image
        run: |
          IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}
          docker push $IMAGE:latest
